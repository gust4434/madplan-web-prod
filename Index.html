<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madplan</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Se ugens madplan med lækre retter. Opdateret løbende fra vores API.">
    <meta name="keywords" content="madplan, ugentlig menu, opskrifter, sund mad">
    <meta name="author" content="Din Virksomhed">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Animate.css for "Wow" Elements -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>


    <!-- Custom Styles -->
   <link rel="stylesheet" href="Style.css"/>
</head>
<body>
    <div class="container animate__animated animate__fadeIn">
        <!-- Language Switcher -->
        <div class="language-switch">
            <button id="danishBtn" class="btn btn-primary mx-1" onclick="switchLanguage('da')">Dansk</button>
            <button id="englishBtn" class="btn btn-secondary mx-1" onclick="switchLanguage('en')">English</button>
        </div>

        <!-- Meal Plan Header -->
        <div class="meal-plan">
            <h1 id="headerTitle">Madplan</h1>
            <div id="loading" class="loading animate__animated animate__fadeIn">Indlæser madplan...</div>
            <div id="weekly-plan" style="display: none;"></div>
        </div>

        <!-- Footer Section -->
        <footer>
            <p>&copy; 2024 - Madplan</p>
            <p>Data hentet fra <a id="apiLink" href="https://lunch.tosi.dk/api/v1/latest.json" target="_blank" rel="noopener">API'en</a></p>
        </footer>        
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">
            <img id="modalImage" src="" alt="Ret billede" class="img-fluid rounded">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Luk</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (Includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = 'http://localhost:3000/api/meals';
        let currentApiUrl = API_URL;
    
        function switchLanguage(language) {
            if (language === 'en') {
                document.getElementById('headerTitle').innerText = 'Meal Plan';
                document.getElementById('danishBtn').classList.remove('btn-primary');
                document.getElementById('danishBtn').classList.add('btn-secondary');
                document.getElementById('englishBtn').classList.remove('btn-secondary');
                document.getElementById('englishBtn').classList.add('btn-primary');
            } else {
                document.getElementById('headerTitle').innerText = 'Madplan';
                document.getElementById('englishBtn').classList.remove('btn-primary');
                document.getElementById('englishBtn').classList.add('btn-secondary');
                document.getElementById('danishBtn').classList.remove('btn-secondary');
                document.getElementById('danishBtn').classList.add('btn-primary');
            }
            fetchMealPlan();
        }
    
        async function fetchMealPlan() {
            const loadingElement = document.getElementById('loading');
            const weeklyPlanElement = document.getElementById('weekly-plan');
            loadingElement.style.display = 'block';
            weeklyPlanElement.style.display = 'none';
    
            try {
                const response = await fetch(currentApiUrl);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                console.log('Fetched Data:', data);
    
                // Check if the required fields are present
                if (data && data.Menus && data.Timestamp && data.Weeknumber) {
                    // Identify the language based on current button states
                    const selectedLanguage = document.getElementById('englishBtn').classList.contains('btn-primary') ? 1 : 0;
                    
                    // Find the relevant menu object based on selected language
                    const menuData = data.Menus.find(menu => menu.Language === selectedLanguage);
                    if (menuData) {
                        generateMealPlan(data.Weeknumber, data.Timestamp.value, menuData.Menu);
                        loadingElement.style.display = 'none';
                        weeklyPlanElement.style.display = 'block';
                    } else {
                        console.error('Menu data for the selected language was not found.');
                        displayCustomError();
                    }
                } else {
                    console.error('Data structure missing required fields:', data);
                    displayCustomError();
                }
            } catch (error) {
                console.error('Error fetching or processing API data:', error);
                displayCustomError();
            } finally {
                loadingElement.style.display = 'none';
            }
        }
    
        function generateMealPlan(weekNumber, timestampValue, menu) {
    const weeklyPlanElement = document.getElementById('weekly-plan');
    weeklyPlanElement.innerHTML = '';

    const timestampMatch = timestampValue.match(/\d+/);
    const timestamp = timestampMatch ? new Date(parseInt(timestampMatch[0])).toLocaleString('da-DK') : 'Ukendt';

    const weekHeader = document.createElement('h2');
    weekHeader.textContent = `Uge ${weekNumber}`;
    weeklyPlanElement.appendChild(weekHeader);

    const timestampPara = document.createElement('p');
    timestampPara.textContent = `Opdateret: ${timestamp}`;
    weeklyPlanElement.appendChild(timestampPara);

    const imageBaseUrl = `https://lunch.tosi.dk/api/v1/assets/${weekNumber}/`;

    const daysInDanish = ['Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag'];
    const daysInEnglish = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    const isEnglish = document.getElementById('englishBtn').classList.contains('btn-primary');
    const days = isEnglish ? daysInEnglish : daysInDanish;

    menu.forEach((dayMenu, index) => {
        const daySection = document.createElement('div');
        daySection.classList.add('day-section');

        const dayHeader = document.createElement('h3');
        dayHeader.textContent = days[index];
        daySection.appendChild(dayHeader);

        const table = document.createElement('table');
        table.classList.add('menu-table', 'table', 'table-hover');

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Type', 'Ret', 'Allergener', 'Billede'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        dayMenu.Menu.forEach(dish => {
            const row = document.createElement('tr');
            const typeCell = document.createElement('td');
            typeCell.textContent = dish.Type;
            row.appendChild(typeCell);

            const dishCell = document.createElement('td');
            dishCell.textContent = dish.Dish;
            row.appendChild(dishCell);

            const allergenCell = document.createElement('td');
            let allergensText = 'No allergens in this dish'; // Default message

            if (dish.Allergener) {
                // Check if there are specific allergens provided
                const allergensMatch = dish.Allergener.match(/\( Allergens: (.*) \)/);
                allergensText = allergensMatch ? allergensMatch[1] : dish.Allergener;
            }

            allergenCell.textContent = allergensText;
            row.appendChild(allergenCell);

            const imageCell = document.createElement('td');
            const img = document.createElement('img');
            img.classList.add('dish-image');
            img.alt = `${dish.Type} billede`;
            img.src = `${imageBaseUrl}${dayMenu.DayIndex || 'fallback'}/${dish.Type.toLowerCase().replace(/\s+/g, '')}.png`;
            img.onerror = () => {
                img.src = `${imageBaseUrl}fallback.png`;
            };
            img.onclick = () => {
                document.getElementById('modalImage').src = img.src;
                const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                imageModal.show();
            };
            imageCell.appendChild(img);
            row.appendChild(imageCell);

            tbody.appendChild(row);
        });
        table.appendChild(tbody);
        daySection.appendChild(table);
        weeklyPlanElement.appendChild(daySection);
    });
}
        function displayCustomError() {
            const weeklyPlanElement = document.getElementById('weekly-plan');
            weeklyPlanElement.innerHTML = `
                <div class="alert alert-danger text-center" role="alert">
                    <h4 class="alert-heading">Beklager, der er sket en fejl!</h4>
                    <p>Vi kan desværre ikke hente madplanen nu. Kontakt venligst <a href="mailto:grkh@netcompany.com">grkh@netcompany.com</a> eller <a href="mailto:tshi@netcompany.com">tshi@netcompany.com</a> for at informere om problemet.</p>
                </div>
            `;
            weeklyPlanElement.style.display = 'block';
        }
    
        window.onload = () => fetchMealPlan();
    </script>
</body>
</html>